
<!DOCTYPE html>
<html>
<head>
  <title>Votazione Giochi</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
</head>
<body>
  <h2>Login</h2>
  <div id="login-box">
    <input id="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button onclick="login()">Accedi</button>
    <p id="login-error" style="color:red;"></p>
  </div>

  <div id="form-box" style="display:none;">
    <h2>Vota i tuoi giochi preferiti (max 5)</h2>
    <textarea id="titoli" rows="6" cols="50" placeholder="Inserisci da 1 a 5 titoli, uno per riga"></textarea><br>
    <button onclick="invia()">Invia voti</button>
    <p id="form-error" style="color:red;"></p>
    <h3>Classifica aggiornata:</h3>
    <ul id="classifica"></ul>
  </div>

  <script>
    const firebaseConfig = {
  	apiKey: "AIzaSyA3BB2mb7Srv89DcEsMiGHx7Js5LzNtv6c",
  	authDomain: "prova-ludoteca.firebaseapp.com",
  	projectId: "prova-ludoteca",
  	storageBucket: "prova-ludoteca.firebasestorage.app",
  	messagingSenderId: "955384331795",
  	appId: "1:955384331795:web:7e4f3077ad666f5a7d89e6",
  	measurementId: "G-RYD1LBTQ7C"
    };
    firebase.initializeApp(firebaseConfig);

    function login() {
      const email = document.getElementById("email").value;
      const pw = document.getElementById("password").value;
      firebase.auth().signInWithEmailAndPassword(email, pw)
        .then(() => {
          document.getElementById("login-box").style.display = "none";
          document.getElementById("form-box").style.display = "block";
        })
        .catch(err => {
          document.getElementById("login-error").innerText = "Login fallito: " + err.message;
        });
    }

    async function invia() {
      const raw = document.getElementById("titoli").value;
      const titoli = raw.split("\n").map(t => t.trim()).filter(t => t);
      if (titoli.length === 0 || titoli.length > 5) {
        document.getElementById("form-error").innerText = "Inserisci da 1 a 5 titoli.";
        return;
      }

      const user = firebase.auth().currentUser;
      const idToken = await user.getIdToken();
      fetch("http://localhost:8000/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ idToken, titoli })
      })
      .then(res => {
        if (!res.ok) return res.json().then(err => { throw err; });
        return res.json();
      })
      .then(classifica => {
        document.getElementById("form-error").innerText = "";
        const ul = document.getElementById("classifica");
        ul.innerHTML = "";
        classifica.forEach(item => {
          const li = document.createElement("li");
          li.innerText = `${item.titolo} â€“ ${item.conteggio}`;
          ul.appendChild(li);
        });
      })
      .catch(err => {
        document.getElementById("form-error").innerText = err.detail || "Errore durante l'invio.";
      });
    }
  </script>
</body>
</html>
